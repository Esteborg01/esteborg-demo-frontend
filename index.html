<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mini Diagn칩stico Esteborg</title>

  <style>
    :root {
      --bg-main: #050509;
      --accent: #f1ca63;
      --accent-strong: #f6e29e;
      --accent-alt: #8fd8ff;
      --text-main: #f5f5ff;
      --text-soft: #c3c3d8;
      --text-dim: #7e7e9c;
      --border-subtle: #25253a;
      --card-bg: #0b0b16;
      --card-inner: #10101d;
      --radius-lg: 20px;
      --radius-pill: 999px;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
        "Inter", sans-serif;
      background: radial-gradient(circle at top, #28224b 0, #050509 55%, #020208 100%);
      color: var(--text-main);
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding: 24px 12px 40px;
    }

    .app {
      width: 100%;
      max-width: 960px;
    }

    .hero {
      text-align: center;
      margin-bottom: 20px;
    }

    .hero-logo {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 8px;
    }

    .hero-logo-mark {
      width: 40px;
      height: 40px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 0, #f8e089 0, #f1c967 18%, #8c46ff 52%, #32127b 90%);
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow:
        0 0 0 1px rgba(0, 0, 0, 0.8),
        0 10px 30px rgba(0, 0, 0, 0.75);
    }

    .hero-logo-mark svg {
      width: 22px;
      height: 22px;
    }

    .hero-logo-text {
      font-size: 0.95rem;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      font-weight: 650;
    }

    .hero-logo-text span {
      color: var(--accent-strong);
    }

    .hero-title {
      font-size: clamp(1.4rem, 2.2vw, 1.7rem);
      line-height: 1.35;
      margin: 0 0 6px;
      font-weight: 640;
    }

    .hero-title span {
      color: var(--accent-strong);
    }

    .hero-sub {
      font-size: 0.9rem;
      color: var(--text-soft);
      max-width: 540px;
      margin: 0 auto;
    }

    .hero-sub strong {
      color: var(--accent-strong);
    }

    .chat-card {
      margin-top: 18px;
      border-radius: 24px;
      background: radial-gradient(circle at top left, #262042 0, #050509 60%);
      border: 1px solid rgba(140, 139, 196, 0.55);
      box-shadow: 0 18px 60px rgba(0, 0, 0, 0.8);
      padding: 16px;
    }

    @media (min-width: 900px) {
      .chat-card {
        padding: 18px 18px 16px;
      }
    }

    .chat-inner {
      border-radius: 18px;
      background: linear-gradient(145deg, #0c0c19, #090915);
      border: 1px solid rgba(111, 111, 180, 0.6);
      padding: 14px 14px 12px;
    }

    .chat-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
    }

    .chat-header-left {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .chat-title {
      font-size: 0.9rem;
      font-weight: 600;
    }

    .chat-subtitle {
      font-size: 0.78rem;
      color: var(--text-dim);
    }

    .chat-header-right {
      font-size: 0.7rem;
      color: var(--text-dim);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .dot-live {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: var(--accent-strong);
      box-shadow: 0 0 0 4px rgba(241, 202, 99, 0.28);
    }

    .chat-box {
      border-radius: 12px;
      padding: 10px 9px;
      background: radial-gradient(circle at top, rgba(32, 32, 64, 0.9) 0, rgba(8, 9, 20, 0.98) 42%);
      border: 1px solid rgba(84, 84, 133, 0.8);
      min-height: 220px;
      /* SIN max-height ni overflow: que crezca y haga scroll la p치gina */
      /* max-height: 340px; */
      /* overflow-y: auto; */
      box-shadow:
        inset 0 0 0 1px rgba(5, 5, 12, 0.8),
        0 14px 40px rgba(0, 0, 0, 0.75);
      scroll-behavior: smooth;
    }

    .chat-box::-webkit-scrollbar {
      width: 6px;
    }

    .chat-box::-webkit-scrollbar-thumb {
      background: rgba(110, 110, 160, 0.7);
      border-radius: 999px;
    }

    .msg-row {
      display: flex;
      margin-bottom: 8px;
    }

    .msg-row.user {
      justify-content: flex-end;
    }

    .bubble {
      max-width: 80%;
      padding: 7px 9px 7px;
      border-radius: 13px;
      font-size: 0.8rem;
      line-height: 1.45;
      border: 1px solid transparent;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.65);
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    .bubble-user {
      background: linear-gradient(135deg, #f1ca63, #f6e29e);
      color: #1c1407;
      border-color: rgba(115, 85, 34, 0.52);
    }

    .bubble-ai {
      background: radial-gradient(circle at top left, rgba(17, 18, 32, 0.98), rgba(11, 12, 24, 0.98));
      color: var(--text-main);
      border-color: rgba(135, 134, 202, 0.62);
    }

    .bubble-ai a {
      color: var(--accent-alt);
      text-decoration: none;
      border-bottom: 1px dotted rgba(143, 216, 210, 0.7);
    }

    .bubble-label {
      font-size: 0.68rem;
      text-transform: uppercase;
      letter-spacing: 0.14em;
      margin-bottom: 3px;
      color: var(--text-dim);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .bubble-label-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: var(--accent);
    }

    .bubble-meta {
      font-size: 0.66rem;
      color: var(--text-dim);
      margin-top: 2px;
      text-align: right;
    }

    .starter-row {
      margin-top: 8px;
      margin-bottom: 6px;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .starter-chip {
      border-radius: 999px;
      padding: 5px 9px;
      font-size: 0.72rem;
      border: 1px solid rgba(191, 190, 232, 0.46);
      background: rgba(25, 24, 72, 0.9);
      color: var(--text-soft);
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 5px;
    }

    .starter-chip:hover {
      border-color: rgba(241, 202, 99, 0.85);
      color: var(--accent-strong);
    }

    .starter-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: var(--accent);
    }

    .input-row {
      display: flex;
      align-items: stretch;
      gap: 8px;
      margin-top: 9px;
    }

    .input-wrapper {
      position: relative;
      flex: 1;
      display: flex;
      align-items: center;
    }

    #userMsg {
      width: 100%;
      border-radius: var(--radius-pill);
      border: 1px solid rgba(124, 124, 180, 0.65);
      background: radial-gradient(circle at top left, rgba(26, 26, 52, 0.9), rgba(8, 9, 20, 0.98));
      color: var(--text-main);
      padding: 8px 100px 8px 12px;
      font-size: 0.8rem;
      outline: none;
      box-shadow:
        0 0 0 1px rgba(0, 0, 0, 0.7),
        0 10px 25px rgba(0, 0, 0, 0.75);
    }

    #userMsg::placeholder {
      color: rgba(159, 159, 210, 0.72);
    }

    .mic-btn {
      position: absolute;
      right: 98px;
      top: 50%;
      transform: translateY(-50%);
      width: 24px;
      height: 24px;
      border-radius: 999px;
      border: 1px solid rgba(143, 216, 210, 0.7);
      background: radial-gradient(circle at 30% 0, rgba(143, 216, 210, 0.7), #3b8a7b);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 0 0 1px rgba(0, 0, 0, 0.7);
      color: #071412;
    }

    .mic-btn svg {
      width: 13px;
      height: 13px;
    }

    .mic-btn.recording {
      animation: pulse 1s infinite;
      border-color: rgba(255, 107, 107, 0.9);
      background: radial-gradient(circle at 30% 0, rgba(255, 143, 143, 0.85), #ff6b6b);
      color: #220606;
    }

    @keyframes pulse {
      0% {
        box-shadow: 0 0 0 0 rgba(255, 107, 107, 0.75);
      }
      70% {
        box-shadow: 0 0 0 10px rgba(255, 107, 107, 0);
      }
      100% {
        box-shadow: 0 0 0 0 rgba(255, 107, 107, 0);
      }
    }

    #sendBtn {
      border-radius: var(--radius-pill);
      border: none;
      padding: 0 14px;
      font-size: 0.8rem;
      font-weight: 560;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      background: linear-gradient(135deg, #f1ca63, #f6e29e);
      color: #21140a;
      cursor: pointer;
      min-width: 130px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      box-shadow:
        0 8px 22px rgba(0, 0, 0, 0.75),
        0 0 0 1px rgba(0, 0, 0, 0.7);
    }

    #sendBtn:disabled {
      opacity: 0.6;
      cursor: default;
    }

    .status-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 8px;
      font-size: 0.72rem;
      color: var(--text-dim);
    }

    #demoStatus {
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .status-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: var(--accent-strong);
      box-shadow: 0 0 0 4px rgba(241, 202, 99, 0.28);
    }

    .status-dot.ended {
      background: #ff6b6b;
      box-shadow: 0 0 0 4px rgba(255, 107, 107, 0.3);
    }

    #ttsToggle {
      border-radius: var(--radius-pill);
      padding: 3px 9px;
      border: 1px solid rgba(143, 216, 210, 0.8);
      background: rgba(7, 26, 24, 0.95);
      color: #9fe9c7;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
    }

    #ttsToggle.off {
      opacity: 0.55;
      border-color: rgba(94, 93, 140, 0.9);
      background: rgba(12, 12, 26, 0.96);
      color: var(--text-dim);
    }

    .demo-note {
      margin-top: 6px;
      font-size: 0.75rem;
      color: var(--text-dim);
    }

    .demo-note a {
      color: var(--accent-strong);
      text-decoration: none;
    }

    @media (max-width: 720px) {
      body {
        padding: 16px 8px 28px;
      }

      .chat-card {
        margin-top: 14px;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <header class="hero">
      <div class="hero-logo">
        <div class="hero-logo-mark">
          <svg viewBox="0 0 40 40" xmlns="http://www.w3.org/2000/svg">
            <defs>
              <linearGradient id="gradHero" x1="0" y1="0" x2="1" y2="1">
                <stop offset="0%" stop-color="#f9e6a9"/>
                <stop offset="35%" stop-color="#f1c45d"/>
                <stop offset="70%" stop-color="#b37cff"/>
                <stop offset="100%" stop-color="#2c0f63"/>
              </linearGradient>
            </defs>
            <circle cx="20" cy="20" r="18" fill="url(#gradHero)" />
            <path d="M14 10c3.5 0 6 3.2 6 7.5S17.5 25 14 25 8 21.8 8 17.5 10.5 10 14 10Z" fill="rgba(12,8,24,0.96)"/>
            <path d="M26 13c2.4 0 4.2 1.9 4.2 4.5S28.4 22 26 22s-4.2-1.9-4.2-4.5S23.6 13 26 13Z" fill="rgba(12,8,24,0.96)"/>
            <path d="M18 13h3.5M18 16h3.5M18 19h3.5M18 22h3.5" stroke="#f9e6a9" stroke-width="1.2" stroke-linecap="round" />
          </svg>
        </div>
        <div class="hero-logo-text">ESTEBORG <span>EXECUTIVE</span></div>
      </div>
      <h1 class="hero-title">
        쯊u comunicaci칩n est치 frenando tu crecimiento profesional?<br />
        <span>Haz el Mini Diagn칩stico Esteborg y desc칰brelo en 2 minutos.</span>
      </h1>
      <p class="hero-sub">
        Un ejercicio guiado por Esteborg, tu entrenador ejecutivo de
        <strong>comunicaci칩n emocional</strong>, <strong>liderazgo</strong> y
        <strong>claridad mental</strong>.
      </p>
    </header>

    <main class="chat-card">
      <div class="chat-inner">
        <div class="chat-header">
          <div class="chat-header-left">
            <div class="chat-title">Mini Diagn칩stico 췅 Comunicaci칩n con Esteborg</div>
            <div class="chat-subtitle">
              Responde como si hablaras con tu coach. Entre m치s claro seas, mejor el diagn칩stico.
            </div>
          </div>
          <div class="chat-header-right">
            <span class="dot-live"></span>
            <span>Demo guiada</span>
          </div>
        </div>

        <div id="chatBox" class="chat-box">
          <div class="msg-row">
            <div class="bubble bubble-ai">
              <div class="bubble-label">
                <span class="bubble-label-dot"></span>
                <span>Esteborg</span>
              </div>
              <div>
                Antes de entrar a tu mini diagn칩stico, dime:
                <strong>쯘n qu칠 idioma quieres que conversemos?</strong>
                Escribe <strong>"espa침ol"</strong> o <strong>"ingl칠s"</strong>.
              </div>
              <div class="bubble-meta">Paso 1 de 3</div>
            </div>
          </div>
        </div>

        <div class="starter-row" id="startersRow">
          <button class="starter-chip" data-starter="Quiero comunicarme mejor con mi equipo.">
            <span class="starter-dot"></span>
            <span>Quiero comunicarme mejor con mi equipo.</span>
          </button>
          <button class="starter-chip" data-starter="Quiero m치s claridad mental para tomar decisiones importantes.">
            <span class="starter-dot"></span>
            <span>Quiero m치s claridad mental para decidir.</span>
          </button>
          <button class="starter-chip" data-starter="Quiero comunicarme mejor con clientes o prospectos.">
            <span class="starter-dot"></span>
            <span>Quiero comunicarme mejor con clientes.</span>
          </button>
        </div>

        <div class="input-row">
          <div class="input-wrapper">
            <input
              id="userMsg"
              type="text"
              placeholder='Escribe aqu칤...'
              autocomplete="off"
            />
            <button class="mic-btn" id="micBtn" type="button" title="Hablar con tu voz">
              <svg viewBox="0 0 24 24">
                <path
                  d="M12 4a2 2 0 0 0-2 2v4a2 2 0 1 0 4 0V6a2 2 0 0 0-2-2Zm-4 6a4 4 0 1 0 8 0h-1.5a2.5 2.5 0 1 1-5 0H8Z"
                  fill="currentColor"
                />
                <path
                  d="M11 15.95V19h2v-3.05a6.002 6.002 0 0 0 5-5.9h-2a4 4 0 1 1-8 0H6a6.002 6.002 0 0 0 5 5.9Z"
                  fill="currentColor"
                />
              </svg>
            </button>
          </div>
          <button id="sendBtn" type="button">
            <span>Enviar a Esteborg</span>
          </button>
        </div>

        <div class="status-row">
          <div id="demoStatus">
            <span class="status-dot"></span>
            <span>Demo activa 췅 primeras interacciones</span>
          </div>
          <button id="ttsToggle" type="button">
            游댉 Voz Esteborg
          </button>
        </div>

        <p class="demo-note">
          Esta demo es gratuita y limitada. Cuando llegue al final, Esteborg te invitar치 a continuar en
          <a href="https://membersvip.esteborg.live" target="_blank" rel="noopener noreferrer">
            Members VIP
          </a>
          con el entrenamiento completo.
        </p>
      </div>
    </main>
  </div>

  <script>
    const doc = document;

    const chatBox = doc.getElementById("chatBox");
    const userMsgInput = doc.getElementById("userMsg");
    const sendBtn = doc.getElementById("sendBtn");
    const demoStatusEl = doc.getElementById("demoStatus");
    const ttsToggleBtn = doc.getElementById("ttsToggle");
    const micBtn = doc.getElementById("micBtn");
    const startersRow = doc.getElementById("startersRow");

    // ==== BACKEND MODULAR ====
    const API_BASE = "https://esteborg88full-backend-modular.onrender.com";
    const API_URL = `${API_BASE}/api/demo/welcome`;
    const TTS_URL = `${API_BASE}/api/voice`;

    let history = [];
    let isSending = false;
    let demoEnded = false;
    let userName = null;
    let introStep = 1; // 1 idioma, 2 nombre, 3 conversaci칩n
    let currentLang = "es";
    let ttsEnabled = true;
    let currentAudio = null;

    // ----- Helpers UI -----
    function formatTextWithLinks(text) {
      if (!text) return "";
      const urlRegex =
        /(https?:\/\/[^\s]+)|(www\.[^\s]+)|(membersvip\.esteborg\.live[^\s]*)/gi;

      return text.replace(urlRegex, (match) => {
        let url = match;
        if (!/^https?:\/\//i.test(url)) {
          if (url.startsWith("www.")) {
            url = "https://" + url;
          } else if (url.startsWith("membersvip.esteborg.live")) {
            url = "https://" + url;
          }
        }
        return `<a href="${url}" target="_blank" rel="noopener noreferrer">${match}</a>`;
      });
    }

    function appendMessage(role, text, meta) {
      const row = doc.createElement("div");
      row.className = "msg-row " + (role === "user" ? "user" : "ai");

      const bubble = doc.createElement("div");
      bubble.className = "bubble " + (role === "user" ? "bubble-user" : "bubble-ai");

      const label = doc.createElement("div");
      label.className = "bubble-label";
      const dot = doc.createElement("span");
      dot.className = "bubble-label-dot";
      const who = doc.createElement("span");
      who.textContent = role === "user" ? (userName || "T칰") : "Esteborg";

      label.appendChild(dot);
      label.appendChild(who);
      bubble.appendChild(label);

      const content = doc.createElement("div");
      if (role === "assistant") {
        content.innerHTML = formatTextWithLinks(text);
      } else {
        content.textContent = text;
      }
      bubble.appendChild(content);

      if (meta) {
        const metaDiv = doc.createElement("div");
        metaDiv.className = "bubble-meta";
        metaDiv.textContent = meta;
        bubble.appendChild(metaDiv);
      }

      row.appendChild(bubble);
      chatBox.appendChild(row);
      chatBox.scrollTop = chatBox.scrollHeight;

      if (role === "assistant") {
        speakFromApi(text);
      }
    }

    function updateDemoStatus(text, ended) {
      if (!demoStatusEl) return;
      demoStatusEl.innerHTML = "";

      const dot = doc.createElement("span");
      dot.className = "status-dot";
      if (ended) dot.classList.add("ended");

      const label = doc.createElement("span");
      label.textContent = text;

      demoStatusEl.appendChild(dot);
      demoStatusEl.appendChild(label);
    }

    function setDemoStatus(status, remaining) {
      if (status === "ended") {
        updateDemoStatus("Demo finalizada 췅 entra a Members VIP para seguir", true);
        demoEnded = true;
        sendBtn.disabled = true;
        userMsgInput.disabled = true;
        return;
      }

      if (typeof remaining === "number") {
        if (remaining <= 0) {
          updateDemoStatus("Demo finalizada 췅 entra a Members VIP para seguir", true);
          demoEnded = true;
          sendBtn.disabled = true;
          userMsgInput.disabled = true;
        } else if (remaining <= 3) {
          updateDemoStatus("Demo activa 췅 칰ltimas " + remaining + " interacciones", false);
        } else {
          updateDemoStatus("Demo activa 췅 " + remaining + " interacciones restantes", false);
        }
      } else {
        updateDemoStatus("Demo activa 췅 primeras interacciones", false);
      }
    }

    function detectLangChoice(message) {
      const text = (message || "").toLowerCase();
      if (text.includes("english") || text.includes("ingl칠s") || text.includes("ingles")) return "en";
      if (text.includes("spanish") || text.includes("espa침ol") || text.includes("espanol")) return "es";
      return currentLang || "es";
    }

    function formatLangForBackend(lang) {
      return (lang || "").toLowerCase().startsWith("en") ? "en" : "es";
    }

    function setLoading(isLoading) {
      isSending = isLoading;
      sendBtn.disabled = isLoading || demoEnded;
      userMsgInput.disabled = demoEnded;
      sendBtn.textContent = isLoading ? "Pensando..." : "Enviar a Esteborg";
    }

    // ----- TTS ElevenLabs v칤a backend modular -----
    async function speakFromApi(text) {
      if (!ttsEnabled || !text) return;

      try {
        const trimmed = text.length > 400 ? text.slice(0, 400) : text;

        const res = await fetch(TTS_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ text: trimmed })
        });

        if (!res.ok) {
          console.error("TTS API error", await res.text());
          return;
        }

        const blob = await res.blob();
        const url = URL.createObjectURL(blob);

        if (currentAudio) {
          try {
            currentAudio.pause();
            currentAudio.currentTime = 0;
          } catch {}
        }

        currentAudio = new Audio(url);
        currentAudio.play();
      } catch (e) {
        console.error("Error al reproducir TTS externo:", e);
      }
    }

    // ----- Env칤o de mensaje -----
    async function sendMessage() {
      if (isSending || demoEnded) return;
      const message = (userMsgInput.value || "").trim();
      if (!message) return;

      appendMessage("user", message);
      userMsgInput.value = "";

      // Paso 1: idioma
      if (introStep === 1) {
        currentLang = detectLangChoice(message);
        const reply =
          currentLang === "en"
            ? "Perfect. We'll talk in English. What's your first name?"
            : "Perfecto. Hablaremos en espa침ol. 쮺칩mo te llamas?";
        introStep = 2;
        appendMessage("assistant", reply, "Paso 2 de 3");
        return;
      }

      // Paso 2: nombre
      if (introStep === 2) {
        userName = message
          .split(" ")
          .map((p) => p.trim())
          .filter(Boolean)
          .slice(0, 2)
          .join(" ");

        const reply =
          currentLang === "en"
            ? `Thanks, ${userName}. Now tell me in one sentence what you want to improve first: your communication, your leadership or your mental clarity.`
            : `Gracias, ${userName}. Ahora dime en una sola frase qu칠 quieres mejorar primero: tu comunicaci칩n, tu liderazgo o tu claridad mental.`;
        introStep = 3;
        appendMessage("assistant", reply, "Paso 3 de 3");
        return;
      }

      // Paso 3+: backend
      setLoading(true);

      try {
        const payload = {
          message,
          userName: userName || "",
          history,
          lang: formatLangForBackend(currentLang),
        };

        const res = await fetch(API_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });

        if (!res.ok) {
          console.error("Error en backend demo:", await res.text());
          const fallbackMsg =
            currentLang === "en"
              ? "There was a connection issue. Try again in a few seconds."
              : "Hubo un problema de conexi칩n. Vuelve a intentar en unos segundos.";
          appendMessage("assistant", fallbackMsg);
          return;
        }

        const data = await res.json();

        if (data && data.reply) {
          appendMessage("assistant", data.reply);
          history.push({ role: "user", content: message });
          history.push({ role: "assistant", content: data.reply });

          if (data.demoStatus) {
            const remaining =
              typeof data.remainingInteractions === "number"
                ? data.remainingInteractions
                : null;
            setDemoStatus(data.demoStatus, remaining);
          }
        } else {
          const fallbackMsg =
            currentLang === "en"
              ? "I couldn't process the response correctly. Try asking in a different way."
              : "No pude procesar bien la respuesta. Intenta preguntarlo de otra forma.";
          appendMessage("assistant", fallbackMsg);
        }
      } catch (err) {
        console.error("Error al llamar al backend:", err);
        const fallbackMsg =
          currentLang === "en"
            ? "There was a connection issue. Try again in a few seconds."
            : "Hubo un problema de conexi칩n. Vuelve a intentar en unos segundos.";
        appendMessage("assistant", fallbackMsg);
      } finally {
        setLoading(false);
      }
    }

    // ----- Eventos -----
    sendBtn.addEventListener("click", () => sendMessage());
    userMsgInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    if (startersRow) {
      startersRow.querySelectorAll(".starter-chip").forEach((chip) => {
        chip.addEventListener("click", () => {
          if (demoEnded || isSending) return;
          const val = chip.getAttribute("data-starter") || chip.textContent || "";
          if (!val.trim()) return;

          if (introStep < 3) {
            appendMessage(
              "assistant",
              "Primero terminemos idioma y nombre, luego usamos tus retos como ejemplo."
            );
            return;
          }

          userMsgInput.value = val;
          sendMessage();
        });
      });
    }

    ttsToggleBtn.addEventListener("click", () => {
      ttsEnabled = !ttsEnabled;
      if (ttsEnabled) {
        ttsToggleBtn.classList.remove("off");
        ttsToggleBtn.textContent = "游댉 Voz Esteborg";
      } else {
        ttsToggleBtn.classList.add("off");
        ttsToggleBtn.textContent = "游댆 Voz desactivada";
        if (currentAudio) {
          try {
            currentAudio.pause();
            currentAudio.currentTime = 0;
          } catch {}
        }
      }
    });

    // ----- Voz de entrada -----
    function setupVoiceInput() {
      if (!("webkitSpeechRecognition" in window) && !("SpeechRecognition" in window)) {
        if (micBtn) micBtn.style.display = "none";
        return;
      }

      const SpeechRecognition =
        window.SpeechRecognition || window.webkitSpeechRecognition;
      const recognition = new SpeechRecognition();
      recognition.lang = "es-MX";
      recognition.continuous = false;
      recognition.interimResults = false;

      let isRecording = false;

      function setRecording(r) {
        isRecording = r;
        if (!micBtn) return;
        if (r) micBtn.classList.add("recording");
        else micBtn.classList.remove("recording");
      }

      if (micBtn) {
        micBtn.addEventListener("click", () => {
          if (isRecording) {
            recognition.stop();
            setRecording(false);
          } else {
            try {
              // ajustar idioma seg칰n elecci칩n actual
              recognition.lang = currentLang === "en" ? "en-US" : "es-MX";
              recognition.start();
              setRecording(true);
            } catch (e) {
              console.warn("Error al iniciar reconocimiento de voz:", e);
            }
          }
        });
      }

      recognition.onresult = (event) => {
        const transcript = event.results[0][0].transcript;
        userMsgInput.value = transcript;
        // 游댠 Enviar autom치ticamente al terminar de escuchar
        sendMessage();
      };

      recognition.onerror = () => setRecording(false);
      recognition.onend = () => setRecording(false);
    }

    setupVoiceInput();
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <title>Demo Esteborg Comunicación</title>
    <meta
      name="description"
      content="Demo limitada de Esteborg: entrenador de comunicación emocional, liderazgo y claridad mental."
    />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <style>
      /* Tus estilos tal cual los tenías, no los toco para no hacer esto eterno */
      /* ... */
    </style>
  </head>
  <body>
    <div class="app">
      <div class="card">
        <h1 class="title">Demo Esteborg Comunicación</h1>
        <p class="subtitle">
          Prueba gratuita y limitada del entrenador Esteborg para mejorar tu
          comunicación, liderazgo y claridad mental.
        </p>

        <div id="startersContainer" class="starters"></div>

        <div id="chatBox" class="chat-box">
          <!-- Mensaje inicial -->
          <div class="bubble-ai">
            Antes de entrar a tu demo, dime: ¿en qué idioma quieres
            interactuar? Escribe "español" o "inglés".
          </div>
        </div>

        <div class="input-row">
          <input
            id="userMsg"
            type="text"
            placeholder="Ej. Quiero comunicarme mejor con mi equipo..."
          />
          <button id="sendBtn">Enviar a Esteborg</button>
        </div>

        <p class="demo-note">
          Esta demo está limitada. Cuando llegue al final, Esteborg te invitará
          a continuar en Members VIP con el entrenamiento completo.
        </p>
      </div>
    </div>

    <script>
      const d = document;

      // Estado global
      let currentLang = "es";
      let introStep = 1; // 1: idioma, 2: nombre, 3+: contenido
      let chatHistory = [];
      let isSending = false;
      let demoEnded = false;
      let ttsEnabled = true;

      const API_URL =
        "https://esteborgcom7-backend.onrender.com/api/demo/welcome";

      // ============================
      // UTILIDADES
      // ============================
      function formatTextWithLinks(text) {
        if (!text) return "";
        const urlRegex =
          /(https?:\/\/[^\s]+)|(www\.[^\s]+)|(membersvip\.esteborg\.live[^\s]*)/gi;

        return text.replace(urlRegex, (match) => {
          let url = match;
          if (!/^https?:\/\//i.test(url)) {
            if (url.startsWith("www.")) {
              url = "https://" + url;
            } else if (url.startsWith("membersvip.esteborg.live")) {
              url = "https://" + url;
            }
          }
          return `<a href="${url}" target="_blank" rel="noopener noreferrer">${match}</a>`;
        });
      }

      function detectLangChoice(message) {
        const text = (message || "").toLowerCase();
        if (text.includes("english") || text.includes("inglés")) return "en";
        if (text.includes("spanish") || text.includes("español")) return "es";
        // Default: español
        return "es";
      }

      function formatLangForBackend(lang) {
        return lang === "en" ? "en" : "es";
      }

      // ============================
      // TTS SOLO VIA ELEVENLABS
      // ============================
      let currentAudio = null;

      async function speakFromApi(text) {
        if (!ttsEnabled || !text) return;

        try {
          const trimmed = text.length > 400 ? text.slice(0, 400) : text;

          const res = await fetch(
            "https://esteborgcom7-backend.onrender.com/api/tts",
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ text: trimmed, lang: currentLang }),
            }
          );

          if (!res.ok) {
            console.error("TTS API error", await res.text());
            return;
          }

          const blob = await res.blob();
          const url = URL.createObjectURL(blob);

          if (currentAudio) {
            try {
              currentAudio.pause();
              currentAudio.currentTime = 0;
            } catch (e) {
              console.warn("Error al detener audio previo:", e);
            }
          }

          currentAudio = new Audio(url);
          currentAudio.play();
        } catch (e) {
          console.error("Error al reproducir TTS externo:", e);
        }
      }

      function appendMessage(role, text) {
        const bubble = document.createElement("div");
        bubble.className = role === "user" ? "bubble-user" : "bubble-ai";

        const box = document.getElementById("chatBox");

        if (role === "assistant") {
          bubble.innerHTML = formatTextWithLinks(text);
        } else {
          bubble.textContent = text;
        }

        box.appendChild(bubble);
        box.scrollTop = box.scrollHeight;

        if (role === "assistant") {
          speakFromApi(text);
        }
      }

      function setLoading(state) {
        const btn = document.getElementById("sendBtn");
        const input = document.getElementById("userMsg");
        isSending = state;
        btn.disabled = state || demoEnded;
        input.disabled = state || demoEnded;
        btn.textContent = state ? "Pensando..." : "Enviar a Esteborg";
      }

      // ============================
      // VOZ / MICRO (SI LO QUIERES DEJAR)
      // ============================
      function setupVoiceInput() {
        // Aquí dejas tu lógica de reconocimiento de voz si ya la tenías,
        // no la toqué porque no estaba directamente relacionada con ElevenLabs.
      }

      // ============================
      // STARTERS
      // ============================
      const starters = [
        "Quiero comunicarme mejor con mi equipo.",
        "Quiero más claridad mental para tomar decisiones importantes.",
        "Cómo mejora la IA en mi comunicación.",
      ];

      function renderStarters() {
        const container = document.getElementById("startersContainer");
        if (!container) return;

        container.innerHTML = "";

        starters.forEach((text) => {
          const btn = document.createElement("button");
          btn.className = "starter-btn";
          btn.textContent = text;
          btn.addEventListener("click", () => {
            if (demoEnded || isSending) return;

            const input = document.getElementById("userMsg");

            if (introStep < 3) {
              input.value = "";
              input.focus();
              appendMessage(
                "assistant",
                "Primero terminemos las preguntas iniciales y luego usamos tus retos como ejemplo."
              );
              return;
            }

            input.value = btn.textContent;
            sendMessage();
          });
          container.appendChild(btn);
        });
      }

      // ============================
      // ENVÍO DE MENSAJE
      // ============================
      async function sendMessage() {
        if (isSending || demoEnded) return;

        const input = document.getElementById("userMsg");
        const message = (input.value || "").trim();
        if (!message) return;

        appendMessage("user", message);

        // ONBOARDING
        if (introStep === 1) {
          currentLang = detectLangChoice(message);
          let q2;
          if (currentLang === "en") {
            q2 = "Great. We'll interact in English. What's your name?";
          } else {
            q2 = "Perfecto. Interactuaremos en español. ¿Cómo te llamas?";
          }
          introStep = 2;
          appendMessage("assistant", q2);
          input.value = "";
          return;
        }

        if (introStep === 2) {
          const name = message.trim() || "Invitado";
          window.esteborgUserName = name;

          const followUp =
            currentLang === "en"
              ? `Thanks, ${name}. Now tell me in one sentence what you want to improve first: your communication, your leadership or your mental clarity.`
              : `Gracias, ${name}. Ahora sí: cuéntame en una frase qué quieres mejorar primero: tu comunicación, tu liderazgo o tu claridad mental.`;

          introStep = 3;
          appendMessage("assistant", followUp);
          input.value = "";
          return;
        }

        // A partir de aquí ya vamos al backend
        setLoading(true);

        try {
          const payload = {
            message,
            userName: window.esteborgUserName || "Invitado",
            history: chatHistory,
            lang: formatLangForBackend(currentLang),
          };

          const res = await fetch(API_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });

          if (!res.ok) {
            console.error("Error en backend demo:", await res.text());
            appendMessage(
              "assistant",
              "Hubo un problema de conexión. Vuelve a intentar en unos segundos."
            );
            return;
          }

          const data = await res.json();
          const reply = data.reply || "";
          const remaining = data.remainingInteractions ?? null;
          const demoStatus = data.demoStatus || "active";

          chatHistory.push({ role: "user", content: message });
          chatHistory.push({ role: "assistant", content: reply });

          appendMessage("assistant", reply);

          if (
            typeof remaining === "number" &&
            remaining <= 0 &&
            demoStatus === "ended"
          ) {
            demoEnded = true;
            const finalMsg =
              currentLang === "en"
                ? "This demo has ended. To continue working with Esteborg in depth, go to Members VIP."
                : "Esta demo ha terminado. Para seguir trabajando con Esteborg a profundidad, entra a Members VIP.";
            appendMessage("assistant", finalMsg);
          }
        } catch (err) {
          console.error("Error al llamar al backend:", err);
          appendMessage(
            "assistant",
            "Hubo un problema de conexión. Vuelve a intentar en unos segundos."
          );
        } finally {
          setLoading(false);
          input.value = "";
        }
      }

      // ============================
      // EVENTOS
      // ============================
      document
        .getElementById("sendBtn")
        .addEventListener("click", () => sendMessage());

      document
        .getElementById("userMsg")
        .addEventListener("keydown", (e) => {
          if (e.key === "Enter" && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
          }
        });

      // ============================
      // INICIO
      // ============================
      // setupTTS(); // Deshabilitado, usamos solo ElevenLabs
      setupVoiceInput();
      renderStarters();
    </script>
  </body>
</html>

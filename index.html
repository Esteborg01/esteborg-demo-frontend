<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Demo Esteborg Ejecutivo</title>

  <style>
    :root {
      --bg-main: #050509;
      --bg-gradient-start: #151521;
      --bg-gradient-end: #050509;
      --card-bg: #0c0c14;
      --card-inner: #101018;
      --accent: #d8b15a;
      --accent-soft: #b89446;
      --accent-soft-2: #8c6a2e;
      --text-main: #f7f7fb;
      --text-soft: #a7a7bc;
      --text-dim: #77778a;
      --border-subtle: rgba(255, 255, 255, 0.06);
      --border-strong: rgba(216, 177, 90, 0.45);
      --radius-lg: 22px;
      --radius-md: 14px;
    }

    * {
      box-sizing: border-box;
    }

    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Inter",
        "Segoe UI", sans-serif;
      font-size: 17px;
      background:
        radial-gradient(circle at top, rgba(216, 177, 90, 0.09) 0, transparent 45%),
        radial-gradient(circle at bottom, #181828 0, #050509 55%);
      color: var(--text-main);
      display: flex;
      min-height: 100vh;
      align-items: center;
      justify-content: center;
      padding: 24px;
    }

    .shell {
      width: 100%;
      max-width: 1040px;
      background: radial-gradient(circle at top left, #181828 0, #050509 60%);
      border-radius: var(--radius-lg);
      padding: 26px 26px 22px;
      position: relative;
      overflow: hidden;
      box-shadow:
        0 26px 80px rgba(0, 0, 0, 0.8),
        0 0 0 1px rgba(216, 177, 90, 0.2);
      border: 1px solid rgba(216, 177, 90, 0.35);
    }

    .shell-inner {
      position: relative;
      display: grid;
      grid-template-columns: minmax(0, 1.2fr) minmax(0, 1.4fr);
      gap: 24px;
      align-items: flex-start;
    }

    @media (max-width: 900px) {
      .shell-inner {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    /* Columna izquierda: info de valor */
    .left-panel {
      padding-right: 10px;
    }

    .eyebrow {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      color: var(--accent-soft);
      margin-bottom: 6px;
    }

    h1 {
      margin: 0;
      font-size: 27px;
      line-height: 1.3;
    }

    .subcopy {
      margin-top: 10px;
      font-size: 15px;
      line-height: 1.7;
      color: var(--text-soft);
    }

    .badge-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 14px;
      font-size: 12px;
    }

    .badge {
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(216, 177, 90, 0.4);
      background: radial-gradient(
        circle at top left,
        rgba(216, 177, 90, 0.16),
        rgba(5, 5, 12, 0.95)
      );
      color: var(--text-soft);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
    }

    .badge-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: #06d39a;
      box-shadow: 0 0 10px rgba(6, 211, 154, 0.8);
    }

    .metrics {
      margin-top: 16px;
      padding: 10px 12px;
      border-radius: 14px;
      background: linear-gradient(
        135deg,
        rgba(216, 177, 90, 0.12),
        rgba(7, 7, 16, 0.96)
      );
      border: 1px solid rgba(216, 177, 90, 0.38);
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      font-size: 13px;
      color: var(--text-soft);
    }

    .metric-item {
      min-width: 120px;
    }

    .metric-label {
      text-transform: uppercase;
      letter-spacing: 0.12em;
      font-size: 10px;
      color: var(--text-dim);
      margin-bottom: 4px;
    }

    .metric-value {
      font-size: 15px;
      color: var(--text-main);
    }

    .metric-tag {
      font-size: 11px;
      color: var(--accent-soft);
      margin-top: 2px;
    }

    .footnote-left {
      margin-top: 14px;
      font-size: 11px;
      color: var(--text-dim);
    }

    .footnote-left span {
      color: var(--accent-soft);
    }

    /* Columna derecha: chat premium */
    .chat-wrapper {
      background: radial-gradient(circle at top right, #202030 0, #08080f 55%);
      border-radius: 18px;
      padding: 16px 14px 14px;
      border: 1px solid rgba(255, 255, 255, 0.04);
      display: flex;
      flex-direction: column;
      /* que crezca seg√∫n el contenido, sin forzar min-height grande */
    }

    .chat-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 13px;
      color: var(--text-soft);
      margin-bottom: 10px;
    }

    .chat-header-left {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .chat-header-right {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .avatar {
      width: 30px;
      height: 30px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 0%, #f5f5f5 0, #d8b15a 40%, #3a2e1a 100%);
      border: 1px solid rgba(0, 0, 0, 0.6);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: 700;
      color: #050509;
      box-shadow: 0 0 0 1px rgba(255, 255, 255, 0.1),
                  0 14px 25px rgba(0, 0, 0, 0.75);
    }

    .avatar span {
      transform: translateY(0.5px);
    }

    .chat-title-block {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .chat-title {
      font-size: 13px;
      font-weight: 600;
      color: var(--text-main);
    }

    .chat-subtitle {
      font-size: 11px;
      color: var(--text-soft);
    }

    .pill-demo {
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(8, 218, 146, 0.12);
      border: 1px solid rgba(8, 218, 146, 0.5);
      font-size: 11px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .pill-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: #08da92;
      box-shadow: 0 0 8px rgba(8, 218, 146, 0.9);
    }

    .tts-toggle {
      border-radius: 999px;
      border: 1px solid var(--border-subtle);
      background: rgba(5, 5, 12, 0.92);
      color: var(--text-soft);
      padding: 6px 9px;
      font-size: 16px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4);
      transition:
        transform 0.08s ease-out,
        box-shadow 0.08s ease-out,
        background 0.08s.ease-out,
        border-color 0.08s ease-out;
    }

    .tts-toggle.on {
      border-color: rgba(216, 177, 90, 0.8);
      box-shadow: 0 0 12px rgba(216, 177, 90, 0.7);
    }

    .chat-box {
      background: rgba(2, 2, 8, 0.97);
      border-radius: 12px;
      padding: 10px 10px 8px;
      /* sin max-height ni overflow, dejamos que crezca y haga scroll la p√°gina */
      flex: none;
      overflow-y: visible;
      border: 1px solid rgba(255, 255, 255, 0.04);
      margin-top: 8px;
    }

    .bubble-user,
    .bubble-ai {
      max-width: 96%;
      margin: 9px 0;
      padding: 10px 13px 9px;
      border-radius: 13px;
      font-size: 18px;
      line-height: 1.6;
    }

    .bubble-user {
      margin-left: auto;
      background: linear-gradient(135deg, #26263c, #131320);
      color: #f9f9ff;
      border: 1px solid rgba(255, 255, 255, 0.08);
      text-align: right;
    }

    .bubble-ai {
      margin-right: auto;
      background: rgba(13, 13, 24, 0.96);
      color: #f5f5f5;
      border: 1px solid var(--border-strong);
      position: relative;
      padding-top: 16px;
    }

    .bubble-ai::before {
      content: "Esteborg";
      position: absolute;
      top: 3px;
      left: 12px;
      font-size: 11px;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      color: var(--accent-soft);
      opacity: 0.95;
    }

    .bubble-ai a {
      color: var(--accent-soft);
      text-decoration: underline;
    }

    /* Starters / iniciadores */
    .starters {
      margin-top: 4px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .starter-btn {
      border-radius: 999px;
      border: 1px solid rgba(216, 177, 90, 0.5);
      background: radial-gradient(
        circle at top left,
        rgba(216, 177, 90, 0.18),
        rgba(5, 5, 12, 0.96)
      );
      color: var(--text-soft);
      font-size: 13px;
      padding: 7px 11px;
      cursor: pointer;
      white-space: nowrap;
      max-width: 100%;
      text-align: left;
      overflow: hidden;
      text-overflow: ellipsis;
      transition:
        background 0.12s ease-out,
        border-color 0.12s ease-out,
        transform 0.06s ease-out;
    }

    .starter-btn:hover {
      background: radial-gradient(
        circle at top left,
        rgba(216, 177, 90, 0.26),
        rgba(10, 10, 18, 0.98)
      );
      border-color: rgba(216, 177, 90, 0.9);
      transform: translateY(-1px);
    }

    .starter-btn:active {
      transform: translateY(0);
    }

    .input-row {
      display: flex;
      gap: 10px;
      margin-top: 11px;
      align-items: center;
    }

    .input-row input {
      flex: 1;
      padding: 12px 13px;
      border-radius: 12px;
      border: 1px solid var(--border-subtle);
      background: rgba(5, 5, 12, 0.92);
      color: var(--text-main);
      font-size: 16px;
      outline: none;
    }

    .input-row input::placeholder {
      color: #6f6f80;
      font-size: 15px;
    }

    .input-row button {
      padding: 11px 18px;
      border-radius: 12px;
      border: none;
      background: linear-gradient(
        135deg,
        var(--accent),
        var(--accent-soft),
        var(--accent-soft-2)
      );
      color: #040308;
      font-weight: 600;
      font-size: 15px;
      cursor: pointer;
      white-space: nowrap;
      box-shadow: 0 12px 26px rgba(216, 177, 90, 0.55);
      transition:
        transform 0.08s ease-out,
        box-shadow 0.08s ease-out,
        filter 0.1s,
        opacity 0.1s;
    }

    .input-row button:hover {
      transform: translateY(-1px);
      box-shadow: 0 16px 34px rgba(216, 177, 90, 0.7);
      filter: brightness(1.04);
    }

    .input-row button:active {
      transform: translateY(0);
      box-shadow: 0 9px 20px rgba(216, 177, 90, 0.6);
      filter: brightness(0.97);
    }

    .input-row button:disabled {
      opacity: 0.7;
      cursor: default;
      box-shadow: 0 8px 18px rgba(216, 177, 90, 0.35);
      transform: none;
    }

    #voiceBtn {
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid var(--border-subtle);
      background: rgba(5, 5, 12, 0.92);
      color: var(--text-soft);
      font-size: 18px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4);
      transition:
        transform 0.08s ease-out,
        box-shadow 0.08s ease-out,
        background 0.08s ease-out,
        border-color 0.08s ease-out;
    }

    #voiceBtn.listening {
      background: rgba(8, 218, 146, 0.16);
      border-color: rgba(8, 218, 146, 0.7);
      box-shadow: 0 0 12px rgba(8, 218, 146, 0.8);
      transform: translateY(-1px);
    }

    .footnote-chat {
      margin-top: 7px;
      font-size: 11px;
      color: var(--text-dim);
    }

    .footnote-chat span {
      color: var(--accent-soft);
    }

    @media (max-width: 900px) {
      body {
        padding: 18px;
      }

      .shell {
        padding: 20px 18px 16px;
      }

      .left-panel {
        padding-right: 0;
      }

      h1 {
        font-size: 24px;
      }

      .metrics {
        margin-top: 14px;
      }
    }

    @media (max-width: 600px) {
      body {
        padding: 14px;
      }

      .shell {
        padding: 18px 14px 14px;
      }

      .shell-inner {
        gap: 18px;
      }

      .bubble-user,
      .bubble-ai {
        font-size: 17px;
      }

      .input-row {
        flex-direction: column;
        align-items: stretch;
      }

      .input-row button {
        width: 100%;
        text-align: center;
        justify-content: center;
      }
    }
  </style>
</head>

<body>
  <div class="shell">
    <div class="shell-inner">
      <!-- Columna izquierda: contexto -->
      <div class="left-panel">
        <div class="eyebrow">Demo ejecutivo Esteborg</div>
        <h1>Prueba c√≥mo Esteborg cambia tu vida para siempre.</h1>
        <p class="subcopy">
          En esta demo Esteborg analiza tu comunicaci√≥n, tu liderazgo y tu claridad mental
          como si fuera un coach ejecutivo real, pero en versi√≥n digital.
          T√∫ pones el reto, √©l te devuelve un diagn√≥stico y acciones puntuales.
        </p>

        <div class="badge-row">
          <div class="badge">
            <span class="badge-dot"></span>
            Sesi√≥n guiada en tiempo real
          </div>
          <div class="badge">
            14 interacciones demo
          </div>
          <div class="badge">
            Enfoque: comunicaci√≥n + liderazgo
          </div>
        </div>

        <div class="metrics">
          <div class="metric-item">
            <div class="metric-label">Modo</div>
            <div class="metric-value">Demo estrat√©gico</div>
            <div class="metric-tag">Sin humo. Solo claridad.</div>
          </div>
          <div class="metric-item">
            <div class="metric-label">Estilo</div>
            <div class="metric-value">Ejecutivo, humano</div>
            <div class="metric-tag">Tono directo y emp√°tico</div>
          </div>
          <div class="metric-item">
            <div class="metric-label">Siguiente paso</div>
            <div class="metric-value">Entrenadores de 7 d√≠as</div>
            <div class="metric-tag">Acceso v√≠a Members VIP</div>
          </div>
        </div>

        <div class="footnote-left">
          Al terminar la demo, podr√°s ir a <span>Esteborg Members VIP</span> para desbloquear
          los programas profundos de comunicaci√≥n, liderazgo y ventas consultivas.
        </div>
      </div>

      <!-- Columna derecha: chat -->
      <div class="chat-wrapper">
        <div class="chat-header">
          <div class="chat-header-left">
            <div class="avatar">
              <span>E</span>
            </div>
            <div class="chat-title-block">
              <div class="chat-title">Esteborg ¬∑ Demo diagn√≥stico</div>
              <div class="chat-subtitle">Entrenador ejecutivo con IA aplicada</div>
            </div>
          </div>
          <div class="chat-header-right">
            <button
              id="ttsToggleBtn"
              class="tts-toggle on"
              type="button"
              title="Activar/desactivar voz de Esteborg"
            >
              üîä
            </button>
            <div class="pill-demo">
              <div class="pill-dot"></div>
              <span id="demoStatusLabel">Demo activo</span>
            </div>
          </div>
        </div>

        <div class="starters">
          <button class="starter-btn">Quiero comunicarme mejor con mi equipo sin tanta fricci√≥n.</button>
          <button class="starter-btn">Siento que no proyecto la autoridad que deber√≠a.</button>
          <button class="starter-btn">Me trabo cuando tengo que decir cosas dif√≠ciles.</button>
          <button class="starter-btn">Quiero m√°s claridad mental para tomar decisiones importantes.</button>
        </div>

        <div id="chatBox" class="chat-box">
          <div class="bubble-ai">
            Antes de entrar a tu demo, dime: ¬øen qu√© idioma quieres interactuar? Escribe "espa√±ol" o "ingl√©s".
          </div>
        </div>

        <div class="input-row">
          <input
            id="userMsg"
            type="text"
            autocomplete="off"
            placeholder="Escribe: espa√±ol o ingl√©s‚Ä¶"
          />
          <button id="voiceBtn" type="button" title="Hablar con Esteborg">
            üé§
          </button>
          <button id="sendBtn" type="button">Enviar a Esteborg</button>
        </div>

        <div class="footnote-chat">
          Esta demo est√° limitada. Cuando llegue al final, Esteborg te invitar√° a continuar en
          <span>Members VIP</span> con el entrenamiento completo.
        </div>
      </div>
    </div>
  </div>

  <script>
    // === CONFIGURACI√ìN DE API ===
    const API_BASE = "https://esteborg88full-backend-modular.onrender.com";
    const API_URL = `${API_BASE}/api/demo/welcome`;
    const TTS_URL = `${API_BASE}/api/voice`;

    let history = [];
    let isSending = false;
    let demoEnded = false;
    let userName = null;

    // 1 = idioma, 2 = voz, 3 = nombre, 4 = conversaci√≥n normal
    let introStep = 1;
    let currentLang = "es"; // "es" o "en"

    // ===== TTS (ElevenLabs) =====
    let ttsEnabled = true;
    let currentAudio = null;

    // ===== STT (micr√≥fono) =====
    let recognition = null;
    let isListening = false;

    const FIXED_PLAN_ANSWER = `‚ú® Qu√© buena pregunta.
Puedes acceder a todos los programas y entrenamientos de Esteban desde esta p√°gina oficial:
üëâ https://membersvip.esteborg.live/

Y adem√°s, hoy tienes un cup√≥n exclusivo del 50% de descuento para cualquier plan:
üéÅ EsteborgVIPOffer

Te recomiendo elegir seg√∫n tu objetivo actual:

üß† Entrenador Inteligente de Comunicaci√≥n Emocional (7 d√≠as) ‚Üí para desarrollar calma, empat√≠a y expresi√≥n consciente.

üí¨ Entrenador Inteligente de Ventas Conscientes (7 d√≠as) ‚Üí si buscas conectar mejor con tus clientes y comunicar valor.

üíé O el bundle completo, con ambos entrenamientos y una sesi√≥n personalizada con Esteban.

¬øQuieres que te ayude a decidir cu√°l de estos tres caminos se adapta mejor a tu situaci√≥n actual?`;

    // ===== HELPERS =====
    function formatTextWithLinks(text) {
      if (!text) return "";
      const urlRegex = /(https?:\/\/[^\s]+)/g;
      return text.replace(
        urlRegex,
        '<a href="$1" target="_blank" rel="noopener noreferrer">$1</a>'
      );
    }

    function detectLangChoice(message) {
      const t = (message || "").toLowerCase();
      if (t.includes("english") || t.includes("ingl√©s") || t.includes("ingles") || t === "en") {
        return "en";
      }
      if (t.includes("espa√±ol") || t.includes("espanol") || t === "es") {
        return "es";
      }
      return "es";
    }

    function detectVoiceGenderChoice(message) {
      const t = (message || "").toLowerCase();
      if (
        t.includes("masculina") ||
        t.includes("hombre") ||
        t.includes("masculino") ||
        t.includes("male") ||
        t.includes("man")
      ) {
        return "m";
      }
      return "f";
    }

    function isPlanQuestion(text) {
      const t = (text || "").toLowerCase();
      return (
        t.includes("d√≥nde contratar") ||
        t.includes("donde contratar") ||
        t.includes("d√≥nde contrato") ||
        t.includes("donde contrato") ||
        t.includes("contratar un plan") ||
        t.includes("contratar el plan") ||
        t.includes("contratar esteborg") ||
        t.includes("d√≥nde compro esteborg") ||
        t.includes("donde compro esteborg") ||
        t.includes("d√≥nde adquirir esteborg") ||
        t.includes("donde adquirir esteborg") ||
        t.includes("planes de esteborg") ||
        t.includes("plan de esteborg") ||
        t.includes("donde contrato un plan de esteborg") ||
        t.includes("d√≥nde contrato un plan de esteborg")
      );
    }

    // ===== TTS con ElevenLabs v√≠a backend =====
    async function speak(text) {
      try {
        if (!ttsEnabled) return;
        if (!text || !text.trim()) return;

        if (currentAudio) {
          currentAudio.pause();
          currentAudio = null;
        }

        const resp = await fetch(TTS_URL, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ text }),
        });

        if (!resp.ok) {
          console.error("Error TTS:", await resp.text());
          return;
        }

        const blob = await resp.blob();
        const url = URL.createObjectURL(blob);
        const audio = new Audio(url);
        currentAudio = audio;
        audio.play().catch((err) => {
          console.error("Error reproduciendo audio:", err);
        });
      } catch (e) {
        console.error("Error en speak():", e);
      }
    }

    // ===== UI HELPERS =====
    function appendMessage(role, text) {
      const bubble = document.createElement("div");
      bubble.className = role === "user" ? "bubble-user" : "bubble-ai";

      const box = document.getElementById("chatBox");

      if (role === "assistant") {
        bubble.innerHTML = formatTextWithLinks(text);
      } else {
        bubble.textContent = text;
      }

      box.appendChild(bubble);
      box.scrollTop = box.scrollHeight;

      if (role === "assistant") {
        speak(text);
      }
    }

    function setLoading(state) {
      const btn = document.getElementById("sendBtn");
      const input = document.getElementById("userMsg");
      isSending = state;
      btn.disabled = state || demoEnded;
      input.disabled = demoEnded;
      if (state) {
        btn.textContent = "Pensando‚Ä¶";
      } else if (!demoEnded) {
        btn.textContent = "Enviar a Esteborg";
      }
    }

    function setDemoStatus(status, remaining) {
      const label = document.getElementById("demoStatusLabel");

      if (status === "ended") {
        demoEnded = true;
        label.textContent = "Demo finalizada";
        return;
      }

      if (remaining === null || remaining === undefined) {
        label.textContent = "Demo activo";
        return;
      }

      label.textContent = `Demo activa ¬∑ ${remaining} interacciones restantes`;
    }

    // ===== STT (micr√≥fono) =====
    function initRecognition() {
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SR) {
        console.warn("SpeechRecognition no soportado en este navegador");
        return null;
      }
      const rec = new SR();
      rec.lang = currentLang === "en" ? "en-US" : "es-MX";
      rec.interimResults = false;
      rec.maxAlternatives = 1;
      return rec;
    }

    function startListening() {
      const voiceBtn = document.getElementById("voiceBtn");
      if (!recognition) {
        recognition = initRecognition();
        if (!recognition) {
          alert(
            "Tu navegador no soporta reconocimiento de voz. Puedes seguir escribiendo tus mensajes."
          );
          return;
        }
      }

      recognition.lang = currentLang === "en" ? "en-US" : "es-MX";

      recognition.onstart = () => {
        isListening = true;
        voiceBtn.classList.add("listening");
      };

      recognition.onerror = (event) => {
        console.error("Error en reconocimiento de voz:", event.error);
        isListening = false;
        voiceBtn.classList.remove("listening");
      };

      recognition.onend = () => {
        isListening = false;
        voiceBtn.classList.remove("listening");
      };

      recognition.onresult = (event) => {
        const transcript = event.results[0][0].transcript || "";
        const input = document.getElementById("userMsg");
        input.value = transcript;
        input.focus();
      };

      try {
        recognition.start();
      } catch (e) {
        console.error("Error al iniciar reconocimiento:", e);
      }
    }

    function toggleListening() {
      if (!recognition || !isListening) {
        startListening();
      } else {
        recognition.stop();
      }
    }

    // ===== L√ìGICA PRINCIPAL =====
    async function sendMessage() {
      if (isSending || demoEnded) return;

      const input = document.getElementById("userMsg");
      const message = (input.value || "").trim();
      if (!message) return;

      appendMessage("user", message);

      // ONBOARDING: paso 1 (idioma)
      if (introStep === 1) {
        currentLang = detectLangChoice(message);

        let q2;
        if (currentLang === "en") {
          q2 =
            "Great. We'll interact in English. Now tell me: do you prefer Esteborg's voice to sound more masculine or more feminine?";
          input.placeholder = "Type: masculine or feminine‚Ä¶";
        } else {
          q2 =
            "Perfecto. Interactuaremos en espa√±ol. Ahora dime: ¬øquieres que la voz de Esteborg suene m√°s masculina o m√°s femenina?";
          input.placeholder = "Escribe: masculina o femenina‚Ä¶";
        }

        appendMessage("assistant", q2);

        history.push({ role: "user", content: message });
        history.push({ role: "assistant", content: q2 });

        introStep = 2;
        input.value = "";
        input.focus();
        return;
      }

      // ONBOARDING: paso 2 (voz)
      if (introStep === 2) {
        detectVoiceGenderChoice(message); // reservado para futuro

        let q3;
        if (currentLang === "en") {
          q3 = "Perfect. What's your name?";
          input.placeholder = "Type your name‚Ä¶";
        } else {
          q3 = "Perfecto. Ahora dime, ¬øc√≥mo te llamas?";
          input.placeholder = "Escribe tu nombre‚Ä¶";
        }

        appendMessage("assistant", q3);

        history.push({ role: "user", content: message });
        history.push({ role: "assistant", content: q3 });

        introStep = 3;
        input.value = "";
        input.focus();
        return;
      }

      // ONBOARDING: paso 3 (nombre)
      if (introStep === 3) {
        userName = message;

        let followUp;
        if (currentLang === "en") {
          followUp =
            `Thanks, ${userName}. ` +
            `Now tell me in one sentence what you want to improve first: ` +
            `your communication, your leadership or your mental clarity.`;
          input.placeholder =
            "E.g. I want to communicate better with my team‚Ä¶";
        } else {
          followUp =
            `Gracias, ${userName}. ` +
            `Ahora s√≠: cu√©ntame en una frase qu√© quieres mejorar primero: ` +
            `tu comunicaci√≥n, tu liderazgo o tu claridad mental.`;
          input.placeholder =
            "Ej. Quiero comunicarme mejor con mi equipo‚Ä¶";
        }

        appendMessage("assistant", followUp);

        history.push({ role: "user", content: message });
        history.push({ role: "assistant", content: followUp });

        introStep = 4;
        input.value = "";
        input.focus();
        return;
      }

      // FIN DE ONBOARDING ‚Üí modo normal

      // Pregunta sobre contratar plan ‚Üí respuesta fija
      if (isPlanQuestion(message)) {
        appendMessage("assistant", FIXED_PLAN_ANSWER);

        history.push({ role: "user", content: message });
        history.push({ role: "assistant", content: FIXED_PLAN_ANSWER });

        input.value = "";
        input.focus();
        return;
      }

      // Mensajes normales ‚Üí backend
      setLoading(true);

      let finalMessage;
      if (currentLang === "en") {
        finalMessage =
          "Please answer in English, using a fresh, modern, executive tone. " +
          message;
      } else {
        finalMessage =
          "Responde en espa√±ol latino neutro, con un tono fresco, moderno y ejecutivo. " +
          message;
      }

      const payload = {
        message: finalMessage,
        userName: userName || "Invitado",
        history: history,
      };

      try {
        const res = await fetch(API_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });

        const data = await res.json();

        if (data && data.reply) {
          appendMessage("assistant", data.reply);
          history.push({ role: "user", content: message });
          history.push({ role: "assistant", content: data.reply });

          if (data.demoStatus) {
            const remaining =
              typeof data.remainingInteractions === "number"
                ? data.remainingInteractions
                : null;

            if (data.demoStatus === "ended") {
              setDemoStatus("ended", 0);
            } else {
              if (remaining !== null && remaining <= 3) {
                setDemoStatus("active", remaining);
              } else {
                setDemoStatus("active", null);
              }
            }
          }
        } else {
          appendMessage(
            "assistant",
            "Hubo un problema de conexi√≥n. Vuelve a intentar en unos segundos."
          );
        }
      } catch (err) {
        console.error(err);
        appendMessage(
          "assistant",
          "Hubo un problema al conectar con el servidor. Intenta de nuevo en unos segundos."
        );
      } finally {
        setLoading(false);
        input.value = "";
        input.focus();
      }
    }

    // ===== EVENTOS UI =====
    function setupUI() {
      const sendBtn = document.getElementById("sendBtn");
      const input = document.getElementById("userMsg");
      const ttsBtn = document.getElementById("ttsToggleBtn");
      const voiceBtn = document.getElementById("voiceBtn");
      const starters = document.querySelectorAll(".starter-btn");

      sendBtn.addEventListener("click", sendMessage);
      input.addEventListener("keydown", (e) => {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });

      ttsBtn.addEventListener("click", () => {
        ttsEnabled = !ttsEnabled;
        if (!ttsEnabled && currentAudio) {
          currentAudio.pause();
          currentAudio = null;
        }
        ttsBtn.textContent = ttsEnabled ? "üîä" : "üîà";
        if (ttsEnabled) {
          ttsBtn.classList.add("on");
        } else {
          ttsBtn.classList.remove("on");
        }
      });

      // Micr√≥fono
      voiceBtn.addEventListener("click", () => {
        toggleListening();
      });

      // Starters ‚Üí rellenan el input
      starters.forEach((btn) => {
        btn.addEventListener("click", () => {
          const text = btn.textContent || "";
          input.value = text;
          input.focus();
        });
      });
    }

    document.addEventListener("DOMContentLoaded", () => {
      setupUI();
    });
  </script>
</body>
</html>
